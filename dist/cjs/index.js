var D=Object.create;var v=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var V=(t,e,r)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var O=(t,e)=>{for(var r in e)v(t,r,{get:e[r],enumerable:!0})},b=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of k(e))!N.call(t,i)&&i!==r&&v(t,i,{get:()=>e[i],enumerable:!(n=j(e,i))||n.enumerable});return t};var M=(t,e,r)=>(r=t!=null?D(H(t)):{},b(e||!t||!t.__esModule?v(r,"default",{value:t,enumerable:!0}):r,t)),Y=t=>b(v({},"__esModule",{value:!0}),t);var s=(t,e,r)=>(V(t,typeof e!="symbol"?e+"":e,r),r);var W={};O(W,{AfterthoughtContext:()=>p,AfterthoughtProvider:()=>L,AfterthoughtService:()=>C,SYM_PROXY_INDICATOR:()=>y,SYM_WATCHES:()=>f,createInjector:()=>R,useInjector:()=>g,useService:()=>E});module.exports=Y(W);var P=require("react");var X=require("react");var y=Symbol("rs_proxy"),f=Symbol("rs_watches"),C=class{get services(){throw new Error("Service not correctly initialized through Afterthought provider, services are unavailable. This is likely a bug")}};function A(){let t=null;return{get isRendering(){return t!==null},notifyIsRendering(){t===null&&(t=setTimeout(()=>{t=null}))},reset(){t&&(clearTimeout(t),t=null)}}}function I(t){return t[f]}function h(...t){}var S=class{constructor(e){this.data=e;s(this,"next");s(this,"prev")}add(e){let r=this.next;this.next=e,e.next=r,e.prev=this}removeSelf(){this.next&&(this.next.prev=this.prev),this.prev&&(this.prev.next=this.next),this.next=void 0,this.prev=void 0}},x=class{constructor(){s(this,"handlersHead",new S(null))}emit(e){let r=this.handlersHead.next;for(;r;)r.data(e),r=r.next}subscribe(e){let r=new S(e);return this.handlersHead.add(r),()=>{r.removeSelf()}}};function R(t){return new _(t)}function m(t){if(Array.isArray(t))return t.map(m);if(t){let e=t[y];if(e)return e}return t}var _=class{constructor(e){s(this,"_renderingTracker",A());s(this,"services",w(this));s(this,"serviceNames",new Map);s(this,"dispatcher",new x);s(this,"serviceInstances",new Map);s(this,"injectorContext",{renderingTracker:this._renderingTracker,dispatcher:this.dispatcher});for(let r in e)this.serviceNames.set(r,e[r]),this.serviceInstances.set(e[r],{instance:this.initService(e[r]),type:e[r],name:r})}subscribe(e){return this.dispatcher.subscribe(e)}getService(e){return this.initServiceProxy(e).proxy}_getDerivedService(e,r){return this.initServiceProxy(e,r).proxy}initServiceProxy(e,r){typeof e=="string"&&(e=this.serviceNames.get(e));let n=this.serviceInstances.get(e);if(!n)throw new Error("Unregistered service "+String(e));r||(r=F());let i=new d(n.instance,n.name,w(this,r),this.injectorContext,r);return{proxy:new Proxy(n.instance,i),proxyHandler:i}}initService(e){let r;if(this.isConstructor(e))try{r=new e}catch(n){if(!n||n.name!=="TypeError"||!(typeof n.message=="string"&&n.message.endsWith("is not a constructor")))throw n;r=e}else r=e;return r}isConstructor(e){var r;return typeof e=="function"&&((r=e==null?void 0:e.prototype)==null?void 0:r.constructor)}};function w(t,e=void 0){return new Proxy({},{get(r,n,i){return typeof n=="string"?t._getDerivedService(n,e):r[n]},set(r,n,i,o){throw new Error("Cannot set a service here, services must be registered.")}})}function F(){return{watches:new Set,servicesRef:{value:null}}}var d=class{constructor(e,r,n,i,o){this.target=e;this.path=r;this.services=n;this.serviceContext=i;this.proxyContext=o;s(this,"proxies",new WeakMap)}get(e,r,n){if(r===y)return this.target;if(r===f)return this.proxyContext.watches;if(r==="services"&&this.services)return this.services;let i,o=this.pathForProp(r);return typeof e[r]=="function"?i=e[r]:e[r]!==null&&typeof e[r]=="object"?((!this.proxies.has(e[r])||this.proxies.get(e[r])==null)&&this.proxies.set(e[r],new Proxy(e[r],new d(e[r],o,null,this.serviceContext,this.proxyContext))),i=this.proxies.get(e[r])):i=e[r],this.serviceContext.renderingTracker.isRendering?(h("RS-listen:",void 0,o),this.proxyContext.watches.add(o)):h("RS-ignore:",void 0,o),i}set(e,r,n,i){if(this.serviceContext.renderingTracker.isRendering)throw new Error('Trying to improperly set property: "'+String(r)+'" during a rendering. This will cause an infinite loop and is not allowed. Full path is "'+this.pathForProp(r)+'"');n=m(n);let o=e[r];if(Array.isArray(e)){let c=e.length,l=e[r];if(e[r]=m(n),l!==n){let T=this.pathForProp(r);this.serviceContext.dispatcher.emit({path:T,oldValue:o,newValue:n})}if(e.length!==c){let T=this.pathForProp("length");this.serviceContext.dispatcher.emit({path:T,oldValue:c,newValue:e.length})}}else if(e[r]=m(n),o!==n){let c=this.pathForProp(r);this.serviceContext.dispatcher.emit({path:c,oldValue:o,newValue:n})}return!0}pathForProp(e){return this.path+"."+String(e)}};var a=M(require("react")),p=(0,a.createContext)(null);function L(t){if(t.injector)return a.default.createElement(p.Provider,{value:t.injector},t.children);{let e=(0,a.useRef)(R(t.services)).current;return a.default.createElement(p.Provider,{value:e},t.children)}}function g(){return(0,P.useContext)(p)}var u=require("react");function E(t){let e=g(),r=(0,u.useRef)(null);r.current===null&&(r.current=e.getService(t));let n=r.current;e._renderingTracker.notifyIsRendering();let[,i]=(0,u.useState)({});return(0,u.useEffect)(()=>{let o=e.subscribe(({path:c})=>{let l=I(n);l.has(c)?(h("RS-handle",l,c),i({})):h("RS-see",l,c)});return()=>{o()}},[]),n}0&&(module.exports={AfterthoughtContext,AfterthoughtProvider,AfterthoughtService,SYM_PROXY_INDICATOR,SYM_WATCHES,createInjector,useInjector,useService});
//# sourceMappingURL=index.js.map
