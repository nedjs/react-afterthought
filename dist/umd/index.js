(function(g,f){typeof exports==='object'&&typeof module!=='undefined'?f(exports,require('react')):typeof define==='function'&&define.amd?define(['exports','react'],f):(g=typeof globalThis!=='undefined'?globalThis:g||self,f(g.Afterthought={},g.React));})(this,(function(exports,b){'use strict';var A=Object.defineProperty;var I=(t,e,r)=>e in t?A(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var s=(t,e,r)=>(I(t,typeof e!="symbol"?e+"":e,r),r);var S=Symbol("rs_proxy"),l=Symbol("rs_watches"),g=class{get services(){throw new Error("Service not correctly initialized through Afterthought provider, services are unavailable. This is likely a bug")}};function T(){let t=null;return {get isRendering(){return t!==null},notifyIsRendering(){t===null&&(t=setTimeout(()=>{t=null;}));},reset(){t&&(clearTimeout(t),t=null);}}}function C(t){return t[l]}function a(...t){}var v=class{constructor(e){this.data=e;s(this,"next");s(this,"prev");}add(e){let r=this.next;this.next=e,e.next=r,e.prev=this;}removeSelf(){this.next&&(this.next.prev=this.prev),this.prev&&(this.prev.next=this.next),this.next=void 0,this.prev=void 0;}},f=class{constructor(){s(this,"handlersHead",new v(null));}emit(e){let r=this.handlersHead.next;for(;r;)r.data(e),r=r.next;}subscribe(e){let r=new v(e);return this.handlersHead.add(r),()=>{r.removeSelf();}}};function R(t){return new x(t)}function d(t){if(Array.isArray(t))return t.map(d);if(t){let e=t[S];if(e)return e}return t}var x=class{constructor(e){s(this,"_renderingTracker",T());s(this,"services",_(this));s(this,"serviceNames",new Map);s(this,"dispatcher",new f);s(this,"serviceInstances",new Map);s(this,"injectorContext",{renderingTracker:this._renderingTracker,dispatcher:this.dispatcher});for(let r in e)this.serviceNames.set(r,e[r]),this.serviceInstances.set(e[r],{instance:this.initService(e[r]),type:e[r],name:r});}subscribe(e){return this.dispatcher.subscribe(e)}getService(e){return this.initServiceProxy(e).proxy}_getDerivedService(e,r){return this.initServiceProxy(e,r).proxy}initServiceProxy(e,r){typeof e=="string"&&(e=this.serviceNames.get(e));let n=this.serviceInstances.get(e);if(!n)throw new Error("Unregistered service "+String(e));r||(r=w());let i=new u(n.instance,n.name,_(this,r),this.injectorContext,r);return {proxy:new Proxy(n.instance,i),proxyHandler:i}}initService(e){let r;if(this.isConstructor(e))try{r=new e;}catch(n){if(!n||n.name!=="TypeError"||!(typeof n.message=="string"&&n.message.endsWith("is not a constructor")))throw n;r=e;}else r=e;return r}isConstructor(e){var r;return typeof e=="function"&&((r=e==null?void 0:e.prototype)==null?void 0:r.constructor)}};function _(t,e=void 0){return new Proxy({},{get(r,n,i){return typeof n=="string"?t._getDerivedService(n,e):r[n]},set(r,n,i,o){throw new Error("Cannot set a service here, services must be registered.")}})}function w(){return {watches:new Set,servicesRef:{value:null}}}var u=class{constructor(e,r,n,i,o){this.target=e;this.path=r;this.services=n;this.serviceContext=i;this.proxyContext=o;s(this,"proxies",new WeakMap);}get(e,r,n){if(r===S)return this.target;if(r===l)return this.proxyContext.watches;if(r==="services"&&this.services)return this.services;let i,o=this.pathForProp(r);return typeof e[r]=="function"?i=e[r]:e[r]!==null&&typeof e[r]=="object"?((!this.proxies.has(e[r])||this.proxies.get(e[r])==null)&&this.proxies.set(e[r],new Proxy(e[r],new u(e[r],o,null,this.serviceContext,this.proxyContext))),i=this.proxies.get(e[r])):i=e[r],this.serviceContext.renderingTracker.isRendering?(this.proxyContext.watches.add(o)):a("RS-ignore:",void 0,o),i}set(e,r,n,i){if(this.serviceContext.renderingTracker.isRendering)throw new Error('Trying to improperly set property: "'+String(r)+'" during a rendering. This will cause an infinite loop and is not allowed. Full path is "'+this.pathForProp(r)+'"');n=d(n);let o=e[r];if(Array.isArray(e)){let c=e.length,h=e[r];if(e[r]=d(n),h!==n){let y=this.pathForProp(r);this.serviceContext.dispatcher.emit({path:y,oldValue:o,newValue:n});}if(e.length!==c){let y=this.pathForProp("length");this.serviceContext.dispatcher.emit({path:y,oldValue:c,newValue:e.length});}}else if(e[r]=d(n),o!==n){let c=this.pathForProp(r);this.serviceContext.dispatcher.emit({path:c,oldValue:o,newValue:n});}return !0}pathForProp(e){return this.path+"."+String(e)}};var p=b.createContext(null);function ne(t){if(t.injector)return b.createElement(p.Provider,{value:t.injector},t.children);{let e=b.useRef(R(t.services)).current;return b.createElement(p.Provider,{value:e},t.children)}}function m(){return b.useContext(p)}function N(t){let e=m(),r=b.useRef(null);r.current===null&&(r.current=e.getService(t));let n=r.current;e._renderingTracker.notifyIsRendering();let[,i]=b.useState({});return b.useEffect(()=>{let o=e.subscribe(({path:c})=>{let h=C(n);h.has(c)?(i({})):a("RS-see",h,c);});return ()=>{o();}},[]),n}exports.AfterthoughtContext=p;exports.AfterthoughtProvider=ne;exports.AfterthoughtService=g;exports.SYM_PROXY_INDICATOR=S;exports.SYM_WATCHES=l;exports.createInjector=R;exports.useInjector=m;exports.useService=N;}));//# sourceMappingURL=index.js.map
